#!/usr/bin/env ruby

require 'yaml'

defaultConfigFile = File.join File.dirname(__FILE__), '..', 'config', 'conf.yml'

config = nil

def loadConfig(configFile)
    YAML.load_file(configFile)
end

def getCommandlineArgument(argname)
    args = {}
    ARGV.each do |arg|
        matcher = /^([^=]+)=(.+)$/.match(arg)
        if (matcher) then
            args[matcher[1]] = matcher[2]
        else
            if (arg == argname) then
                args[arg] = true
            end
        end
    end
    args[argname]
end
 
configFilename = getCommandlineArgument('--config').nil? ? defaultConfigFile : getCommandlineArgument('--config')
config = loadConfig(configFilename)
config['locale'] = ENV['LOCALE'] unless ENV['locale']
config['pid'] = getCommandlineArgument('--pid')
config['log'] = getCommandlineArgument('--log')
config['daemon'] = true unless getCommandlineArgument('--daemon').nil?

p = [
    File.dirname(__FILE__),
    '..',
    'src'
]

$LOAD_PATH.unshift(File.expand_path(File.join(p)))
require 'server'

server = Server.new(config)
server.start

log("Shutdown complete.")
